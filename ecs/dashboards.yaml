Parameters:
  ALBFullName:
    Type: String
  ClusterName:
    Type: String
  FontColorServiceName:
    Type: String
  FontSizeServiceName:
    Type: String
  FrontendServiceName:
    Type: String
  JobQueueName:
    Type: String
  WordServiceName:
    Type: String
  WorkerNodeASGName:
    Type: String
  WorkerServiceName:
    Type: String

Resources:
  Dashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
          "start": "-PT3H",
          "periodOverride": "auto",
          "widgets": [
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApplicationELB", "TargetResponseTime", "LoadBalancer", "${ALBFullName}", { "stat": "p90" } ],
                  [ "...", { "stat": "p95" } ],
                  [ "..." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "p99",
                "period": 60,
                "liveData": false,
                "annotations": {
                  "horizontal": [
                    {
                      "label": "p90 > 200ms",
                      "value": 0.200
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Average Service CPUUtilization",
                "metrics": [
                  [ "AWS/ECS", "CPUUtilization", "ClusterName", "${ClusterName}", "ServiceName", "${FrontendServiceName}", { "stat": "Average" } ],
                  [ ".", ".", ".", ".", ".", "${FontColorServiceName}", { "stat": "Average" } ],
                  [ ".", ".", ".", ".", ".", "${FontSizeServiceName}", { "stat": "Average" } ],
                  [ ".", ".", ".", ".", ".", "${WordServiceName}", { "stat": "Average" } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "p99",
                "period": 60,
                "liveData": false,
                "yAxis": {
                  "left": {
                    "min": 0,
                    "max": 100
                  }
                },
                "annotations": {
                  "horizontal": [
                    {
                      "label": "Service Scale Up",
                      "value": 30
                    },
                    {
                      "label": "Service Scale Down",
                      "value": 15,
                      "color": "#77b300"
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApplicationELB", "RequestCount", "LoadBalancer", "${ALBFullName}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApplicationELB", "HTTPCode_ELB_5XX_Count", "LoadBalancer", "${ALBFullName}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "title": "ECS Cluster Worker Nodes",
                "metrics": [
                  [ "AWS/AutoScaling", "GroupDesiredCapacity", "AutoScalingGroupName", "${WorkerNodeASGName}" ],
                  [ ".", "GroupMaxSize", ".", "." ],
                  [ ".", "GroupMinSize", ".", "." ],
                  [ ".", "GroupInServiceInstances", ".", "." ],
                  [ ".", "GroupPendingInstances", ".", "." ],
                  [ ".", "GroupTotalInstances", ".", "." ],
                  [ ".", "GroupTerminatingInstances", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": {
                "markdown": "# Worker Service"
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Queue - ApproximateNumberOfMessagesVisible",
                "metrics": [
                  [ "AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${JobQueueName}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Queue - ApproximateAgeOfOldestMessage",
                "metrics": [
                  [ "AWS/SQS", "ApproximateAgeOfOldestMessage", "QueueName", "${JobQueueName}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Average",
                "period": 60
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Service Tasks Count",
                "metrics": [
                  [ "ECS/ContainerInsights", "RunningTaskCount", "ServiceName", "${WorkerServiceName}", "ClusterName", "${ClusterName}" ],
                  [ ".", "DesiredTaskCount", ".", ".", ".", "." ],
                  [ ".", "PendingTaskCount", ".", ".", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "stat": "Sum",
                "period": 60
              }
            }
          ]
        }
